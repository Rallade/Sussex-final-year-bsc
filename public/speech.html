<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Web Speech API</title>
    <style>
      body {
        font-family: helvetica;
        font-size: 50px;
      }
      div {
        text-align: center;
        padding-top: 35%;
      }
    </style>
  </head>
  <body>
    <div>
      <span id="speech"></span>
      <span id="interim"></span>
      <span id="response"></span>
    </div>
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript">
    function upgrade() {
      alert('Please use Google Chrome');
    }

    window.onload = function() {
      if (!(window.webkitSpeechRecognition) && !(window.speechRecognition)){
        upgrade();
      }
      spoken = document.getElementById('speech');
      guess = document.getElementById('interim');

      speech = new webkitSpeechRecognition() || speechRecognition();

      speech.continuous = false;
      speech.interimResults = true;
      speech.lang = 'fr';
      speech.start();

      speech.onstart = function(){
        recognizing = true;
        document.getElementById('response').innerHTML = '';
      }

      speech.onresult = function(event){
        var guess_transcript = '';
        var spoken_transcript = '';

        for (var i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            spoken_transcript += event.results[i][0].transcript;
          } else {
            guess_transcript += event.results[i][0].transcript;
          }
        }

        spoken.innerHTML = spoken_transcript;
        guess.innerHTML = guess_transcript;

      };

      speech.onerror = function(event){
        console.error(event.error);
      };

      speech.onend = function (){
        recognizing = false;
        if(spoken.innerHTML != ''){
          $.ajax({
            type: 'POST',
            url: 'http://' + window.location.host + '/process',
            data: {
              sent: spoken.innerHTML,
              test: 'this is a test'
            },
            success: function (data) {
              document.getElementById('response').innerHTML = data;
            }
          });
        }
        reset();
      }
      function reset() {
        recog = false;
        guess.innerHTML = '';
        spoken.innerHTML = '';
        speech.start();
      }
    }
  </script>
</html>
