<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Web Speech API</title>
    <style>
      body {
        font-family: helvetica;
        font-size: 50px;
      }
      div {
        text-align: center;
        padding-top: 25%;
      }
      .error {
          background-color: #fc5944;
      }
    </style>
  </head>
  <body>
    <div>
      <p>
        <span id="speech"></span>
        <span id="interim"></span>
      </p>
      <p>
        <span id="result"></span>
      </p>
      <p>
        <span id="response"></span>
      </p>
    </div>
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript">
    function upgrade() {
      alert('Please use Google Chrome');
    }

    var localData = {};

    window.onload = function() {
      if (!(window.webkitSpeechRecognition) && !(window.speechRecognition)){
        upgrade();
      }
      spoken = document.getElementById('speech');
      guess = document.getElementById('interim');
      actualSpoken = document.getElementById('result')

      speech = new webkitSpeechRecognition() || speechRecognition();

      speech.continuous = false;
      speech.interimResults = true;
      speech.lang = 'fr';
      speech.start();

      speech.onstart = function(){
        recognizing = true;

      }

      speech.onresult = function(event){
        var guess_transcript = '';
        var spoken_transcript = '';

        for (var i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            spoken_transcript += event.results[i][0].transcript;
          } else {
            guess_transcript += event.results[i][0].transcript;
          }
        }

        spoken.innerHTML = spoken_transcript;
        guess.innerHTML = guess_transcript;

      };

      speech.onerror = function(event){
        console.error(event.error);
      };

      speech.onend = function (){
        recognizing = false;
        localData.sent = spoken.innerHTML;
        if(spoken.innerHTML != ''){
          $.ajax({
            type: 'POST',
            url: 'http://' + window.location.host + '/process',
            data: localData,
            success: function (data) {
              alert(data)
              document.getElementById('response').innerHTML = JSON.stringify(JSON.parse(data).response);
              actualSpoken.innerHTML = spoken.innerHTML;
              spoken.innerHTML = '';
              localData = JSON.parse(data);
              var offset = 0;
              var startSpan = "<span class=\"error\">";
              var endSpan = "</span>";
              for (match of JSON.parse(data).grammar){
                if (match.rule.issueType != 'typographical'){
                  var start = match.offset + offset;
                  actualSpoken.innerHTML = actualSpoken.innerHTML.slice(0, start) + startSpan + actualSpoken.innerHTML.slice(start);
                  offset += startSpan.length;
                  var end = match.offset + match.length + offset;
                  actualSpoken.innerHTML = actualSpoken.innerHTML.slice(0, end) + endSpan + actualSpoken.innerHTML.slice(end);
                  offset += endSpan.length;
                }
              }
            }
          });
        }
        reset();
      }
      function reset() {
        recog = false;
        guess.innerHTML = '';
        //spoken.innerHTML = '';
        speech.start();
      }
    }
  </script>
</html>
